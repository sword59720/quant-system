# 实验记录（crypto 模块）

## 2026-02-19 Crypto 双向模型四次优化（局部精细搜索，命中 50/10）

### 1. 搜索动作
- 执行局部精细搜索 900 轮（围绕当前最优参数邻域）：
  - 报告：`/Users/haojc/work/quant-system/outputs/reports/crypto_contract_target_search_local_refine.json`
- 目标：在 `max_drawdown >= -10%` 前提下尽量提高全样本年化，并核验 OOS / stress。

### 2. 命中参数（best_full_ddpass）
- `momentum_lookback_bars=[90,180]`，`momentum_weights=[1.0,0.0]`
- `ma_window_bars=240`，`vol_window_bars=40`
- `momentum_threshold_pct=1.0`
- `rebalance_threshold=0.01`
- `max_exposure_pct=1.0`
- `ls_long_alloc_pct=0.2`，`ls_short_alloc_pct=0.7`
- `ls_short_requires_risk_off=false`
- `ls_dynamic_budget_enabled=true`
- `ls_regime_momentum_threshold_pct=0.2`
- `ls_regime_trend_breadth=0.6`
- `ls_regime_up_long_alloc_pct=0.8`，`ls_regime_up_short_alloc_pct=0.0`
- `ls_regime_neutral_long_alloc_pct=0.2`，`ls_regime_neutral_short_alloc_pct=0.5`
- `ls_regime_down_long_alloc_pct=0.0`，`ls_regime_down_short_alloc_pct=0.8`
- `risk_managed.target_vol_annual=0.10`
- `risk_managed.vol_lookback_bars=60`
- `risk_managed.max_leverage=2.5`
- `drawdown_throttle.trigger_dd=-0.04`
- `drawdown_throttle.reduced_alloc_multiplier=0.15`
- `risk_off_threshold_pct=-1.0`

### 3. 落地后验证结果
来源：`/Users/haojc/work/quant-system/outputs/reports/crypto_contract_validation.json`

- 全样本：年化 `55.58%`，最大回撤 `-8.28%`（命中 50/10）
- OOS30（2025-11-11 起）：年化 `55.97%`，最大回撤 `-5.56%`
- OOS20（2025-12-14 起）：年化 `383.96%`，最大回撤 `-4.32%`
- stress_mild：年化 `33.21%`，最大回撤 `-9.09%`

### 4. 风险备注
- `rolling_oos_all_pass=false`：其中一个滚动窗口（`window_ratio=0.65`，2025-10-25 起）年化为负，说明阶段性稳定性仍有缺口。
- 结论：已命中终极收益/回撤门槛，但后续仍需做滚动稳健性修复。

## 2026-02-19 Crypto 双向模型三次优化（局部快搜 + 动态预算增强）

### 1. 继续优化动作
- 在既有 `advanced_ls_rmm` 基础上，使用“回撤约束优先（`max_drawdown >= -10%`）”快搜 650 轮，聚焦提升全样本年化。
- 快搜报告：
  - `/Users/haojc/work/quant-system/outputs/reports/crypto_contract_target_search_ultimate_fast.json`

### 2. 本轮最优参数（best_full_ddpass）
- `top_n=1`，`short_top_n=2`
- `momentum_lookback_bars=[90,180]`，`momentum_weights=[1.0,0.0]`
- `ma_window_bars=180`，`vol_window_bars=30`
- `rebalance_threshold=0.01`
- `max_exposure_pct=0.8`
- `ls_long_alloc_pct=0.3`，`ls_short_alloc_pct=0.7`
- `ls_short_requires_risk_off=false`
- `ls_dynamic_budget_enabled=true`
- `ls_regime_up_long_alloc_pct=1.0`，`ls_regime_up_short_alloc_pct=0.1`
- `ls_regime_neutral_long_alloc_pct=0.3`，`ls_regime_neutral_short_alloc_pct=0.4`
- `ls_regime_down_long_alloc_pct=0.2`，`ls_regime_down_short_alloc_pct=0.6`
- `target_vol_annual=0.10`，`vol_lookback_bars=40`，`max_leverage=2.5`
- `drawdown_throttle: trigger_dd=-0.04, reduced_alloc_multiplier=0.1`
- `risk_off_threshold_pct=-2.0`

### 3. 落地后验证
来源：`/Users/haojc/work/quant-system/outputs/reports/crypto_contract_validation.json`

- 全样本：年化 `30.83%`，最大回撤 `-7.16%`
- OOS30（2025-11-11 起）：年化 `20.51%`，最大回撤 `-5.50%`
- OOS20（2025-12-14 起）：年化 `32.69%`，最大回撤 `-5.57%`
- stress_mild：年化 `17.09%`，最大回撤 `-8.02%`
- `rolling_oos_all_pass=true`

### 4. 对比上一版
- 上一版：全样本约 `24.84% / -9.93%`
- 当前版：全样本约 `30.83% / -7.16%`
- 结论：收益与回撤同时改善。

### 5. 与终极目标差距
- 目前仍未达到 `年化>50%、回撤<10%`。
- 但在当前 BTC/ETH 双标的数据与成本假设下，已将稳定可行解提升到约 `31%` 年化水平。

## 2026-02-19 Crypto 双向模型二次升级（动态预算 + 50/10 目标搜索）

### 1. 代码升级
- 新增双向动态预算机制（`risk_on/neutral/risk_off`）：
  - `scripts/run_crypto.py`
  - `scripts/backtest_v3.py`
  - `scripts/validate_crypto_contract.py`
- 优化器新增动态预算参数搜索与“终极目标门控”：
  - `scripts/optimize_crypto_contract.py`
  - 新增统计：`ultimate_target_count`、`best_ultimate_target`
- 新增回归测试：
  - `tests/test_run_crypto.py`（新增动态预算 risk_off 偏空用例）

### 2. 目标搜索结果（年化 >50%、回撤 <10%）
- 宽空间 650 轮硬约束搜索：`hits_target=0`
  - 最佳可行（满足回撤<10%）约：年化 `24.84%`，最大回撤 `-9.93%`
  - 报告：`/Users/haojc/work/quant-system/outputs/reports/crypto_contract_target_search_50_10.json`
- 动态预算 160 轮搜索：`ultimate_target_count=0`
  - 报告：`/Users/haojc/work/quant-system/outputs/reports/crypto_contract_search.json`
- 上限诊断（fee=0）显示模型有较高收益潜力，但回撤仍超限：
  - 年化约 `69.11%`，最大回撤 `-11.98%`

### 3. 本次落地参数（当前最优平衡）
- 已更新 `config/crypto.yaml`：
  - `momentum_weights=[0.8,0.2]`
  - `vol_window_bars=12`
  - `rebalance_threshold=0.005`
  - `max_exposure_pct=0.6`
  - `ls_long_alloc_pct=0.5`
  - `ls_short_alloc_pct=0.4`
  - `ls_short_requires_risk_off=true`
  - `target_vol_annual=0.10`
  - `vol_lookback_bars=20`
  - `drawdown_throttle: trigger_dd=-0.12, reduced_alloc_multiplier=0.1`
  - `risk_off_threshold_pct=0.0`
  - 动态预算参数已配置，当前 `ls_dynamic_budget_enabled=false`

### 4. 最新验证（落地后）
来源：`/Users/haojc/work/quant-system/outputs/reports/crypto_contract_validation.json`

- 全样本：年化 `24.84%`，最大回撤 `-9.93%`
- OOS30（2025-11-11 起）：年化 `40.75%`，最大回撤 `-4.29%`
- OOS20（2025-12-14 起）：年化 `82.02%`，最大回撤 `-4.32%`
- `rolling_oos_all_pass=true`
- stress_mild：年化 `12.56%`，最大回撤 `-11.66%`

### 5. 结论
- 当前模型已是双向交易并完成动态预算能力升级，但在现有样本与成本假设下，`50%/10%` 目标仍未命中。
- 现阶段最优平衡点已从约 `19%/-8.4%` 提升到约 `24.8%/-9.9%`。

## 2026-02-19 Crypto 双向模型续优化（含滚动 OOS）

### 1. 扩币池状态
- 尝试联网扩币池失败（DNS 解析受限）：`api.binance.com`、`api.huobi.pro` 等均无法解析。
- 当前可用本地数据仍为：`BTC/USDT`、`ETH/USDT`。

### 2. 脚本能力升级
- `scripts/optimize_crypto_contract.py` 新增 `--engine`，可仅搜索 `advanced_ls_rmm`。
- `scripts/validate_crypto_contract.py` 新增 `rolling_oos` 窗口评估与 `rolling_oos_all_pass` 门控。

### 3. 双向专用搜索
- 命令：`python3 scripts/optimize_crypto_contract.py --trials 120 --seed 42 --engine advanced_ls_rmm`
- 输出：`/Users/haojc/work/quant-system/outputs/reports/crypto_contract_search.json`
- 结果：出现 `strict_target_pass=true` 候选（`strict_target_count=4`）。

### 4. 采用参数（best_strict_target）
- `engine=advanced_ls_rmm`
- `top_n=1`，`short_top_n=2`
- `momentum_lookback_bars=[90,180]`
- `vol_window_bars=30`
- `rebalance_threshold=0.02`
- `max_exposure_pct=0.50`
- `ls_long_alloc_pct=0.40`
- `ls_short_alloc_pct=0.30`
- `target_vol_annual=0.12`
- `vol_lookback_bars=40`
- `max_leverage=1.2`
- `drawdown_throttle: trigger_dd=-0.06, reduced_alloc_multiplier=0.2`
- `risk_off_threshold_pct=2.0`

### 5. 验证结果（采用后）
来源：`/Users/haojc/work/quant-system/outputs/reports/crypto_contract_validation.json`

- 全样本：年化 `19.03%`，最大回撤 `-8.38%`
- OOS30（2025-11-09 起）：年化 `22.99%`，最大回撤 `-5.80%`
- OOS20（2025-12-13 起）：年化 `100.10%`，最大回撤 `-3.57%`
- stress_mild：年化 `9.30%`，最大回撤 `-8.90%`
- `oos_focus_pass=true`
- `rolling_oos_all_pass=true`

### 6. 当前执行侧信号
- `run_crypto` 结果为双向模型输出，当前市场给出空头组合：
  - `BTC/USDT=-0.1261`
  - `ETH/USDT=-0.0928`
- `generate_trades` 已生成合约动作：
  - `OPEN_SHORT BTC/USDT`
  - `OPEN_SHORT ETH/USDT`

## 2026-02-19 Crypto 双向模型适配检查与改造

### 1. 问题确认
- 旧逻辑存在“偏单向”问题：`risk_on` 只开多，`risk_off` 才允许开空，不能在同一周期同时做多强币+做空弱币。
- 交易生成层旧逻辑仅按净差生成 `BUY/SELL`，缺少合约开平动作拆分（`OPEN/CLOSE_LONG/SHORT`）。

### 2. 改造内容
- 信号模型新增并启用：`engine=advanced_ls_rmm`（双向 long/short 同步构建）。
- 生产信号与回测口径统一改造：
  - `scripts/run_crypto.py`
  - `scripts/validate_crypto_contract.py`
  - `scripts/backtest_v3.py`
- 交易生成改造：
  - `scripts/generate_trades.py` 支持合约开平动作拆分（跨零换向时“先平后开”）。

### 3. 当前配置
- `engine=advanced_ls_rmm`
- `ls_long_alloc_pct=0.30`
- `ls_short_alloc_pct=0.30`
- `ls_short_requires_risk_off=false`
- `max_leverage=1.0`

### 4. 验证结果
来源：`/Users/haojc/work/quant-system/outputs/reports/crypto_contract_validation.json`

- 全样本：年化 `2.40%`，最大回撤 `-8.15%`
- OOS 30%（`2025-11-09` 起）：年化 `39.85%`，最大回撤 `-4.86%`
- OOS 20%（`2025-12-13` 起）：年化 `174.95%`，最大回撤 `-4.08%`
- stress_mild：年化 `1.89%`，最大回撤 `-8.04%`

### 5. 结论
- “模型是否偏多头、回测是否未适配双向”这个问题是存在的，已完成结构级修复。
- 后续重点是扩展币种池（当前仅 BTC/ETH）并继续做参数稳健性搜索。

## 2026-02-19 Crypto 合约模型 OOS 优化（advanced_rmm）

### 1. 问题
- OOS 窗口（`2025-11-09` 之后）表现显著走弱，原配置为：
  - `oos_30pct` 年化：`-15.06%`
  - `oos_20pct` 年化：`-16.86%`
  - OOS 最大回撤约：`-4.41% / -4.19%`

### 2. 优化思路
- 从“强趋势多头”切换到“可防守可做空”的状态化模型参数：
  - 合约允许做空：`trade.allow_short=true`
  - risk_off 切换做空：`short_on_risk_off=true`
  - 保持低杠杆上限：`risk_managed.max_leverage=1.0`
  - 维持长期动量 + 趋势过滤：`momentum=[90,180]` + `ma_window=180`
  - 提升组合分散：`top_n=2`，`short_top_n=1`

### 3. 新参数（关键项）
- `top_n=2`
- `short_top_n=1`
- `momentum_threshold_pct=0.5`
- `rebalance_threshold=0.01`
- `max_exposure_pct=1.0`
- `target_vol_annual=0.20`
- `max_leverage=1.0`
- `risk_off_threshold_pct=-2.0`

### 4. 验证结果（`scripts/validate_crypto_contract.py`）
- 全样本：
  - 年化：`9.35%`
  - 最大回撤：`-8.50%`
- OOS 30%（`2025-11-09` 起）：
  - 年化：`43.57%`
  - 最大回撤：`-4.45%`
- OOS 20%（`2025-12-13` 起）：
  - 年化：`182.19%`
  - 最大回撤：`-4.08%`
- 成本压力（mild: `3bps + 1bp/bar funding`）：
  - 年化：`5.78%`
  - 最大回撤：`-8.06%`

### 5. 结论
- 新配置显著修复了近期下行 OOS 失效问题，并保持回撤可控。
- 后续优化建议：继续扩展币种池（当前仅 `BTC/USDT`、`ETH/USDT`）以降低双标的结构性风险。

## 2026-02-19 Crypto 参数搜索复跑（120 轮）

### 1. 执行
- 命令：`python3 scripts/optimize_crypto_contract.py --trials 120 --seed 42`
- 结果文件：`/Users/haojc/work/quant-system/outputs/reports/crypto_contract_search.json`

### 2. 搜索最优（best_by_score）
- `trial=36`，核心参数：
  - `top_n=1`，`short_top_n=2`
  - `momentum_lookback_bars=[60,120]`，`momentum_weights=[0.8,0.2]`
  - `ma_window_bars=240`，`momentum_threshold_pct=2.0`
  - `target_vol_annual=0.20`，`max_leverage=1.5`
- 指标：
  - full 年化：`6.71%`，最大回撤：`-10.26%`
  - OOS30 年化：`45.96%`，最大回撤：`-5.86%`
  - OOS20 年化：`264.49%`，最大回撤：`-3.46%`
  - stress_mild 年化：`1.48%`，最大回撤：`-11.40%`

### 3. 覆盖决策
- 本轮 `strict_target_count=0`，无严格达标解。
- `best_by_score` 相比当前已落地配置在全样本与压力场景更弱（full/stress 回撤与收益均不占优）。
- 结论：本轮不覆盖 `config/crypto.yaml`，继续使用当前已上线参数组合（更均衡，且 `oos_focus_pass=true`）。

