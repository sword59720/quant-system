# 实验记录

## 2026-02-17 股票模型接入与回测记录

### 1. 目标
- 将股票生产信号切换到 `dual_momentum_trend_ivol_defense` 模型。
- 验证该模型相对基准 `510300` 的超额收益。

### 2. 本次测试配置
- 环境：`paper`
- 总资金：`20000`
- 股票资金分配：`0.70`
- 股票单标上限：`0.50`
- 股票总仓上限：`0.70`

模型参数（回测与生产一致）：
- `rebalance_days`: `20`
- `momentum_lb`: `252`
- `ma_window`: `200`
- `vol_window`: `20`
- `top_n`: `1`
- `fee`: `0.0008`
- `min_score`: `0.0`
- `benchmark_symbol`: `510300`
- `defensive_symbol`: `511010`
- `defensive_bypass_single_max`: `true`

### 3. 回测结果
来源文件：`/Users/haojc/work/quant-system/outputs/reports/stock_global_model_report.json`

样本外（2023-01-03 之后）：
- 策略年化：`0.1679210629`
- 基准年化：`0.0946587018`
- 年化超额：`+0.0732623612`
- 策略最大回撤：`-0.1891511196`
- 基准最大回撤：`-0.2415286624`
- 策略终值：`1.5921095910`
- 基准终值：`1.3112343967`

全周期：
- 策略年化：`0.1555737278`
- 基准年化：`0.0647974386`
- 年化超额：`+0.0907762892`
- 策略最大回撤：`-0.2317839787`
- 基准最大回撤：`-0.4474758723`
- 策略终值：`2.6266285144`
- 基准终值：`1.5209137709`

### 4. 当前生产信号输出快照
来源文件：`/Users/haojc/work/quant-system/outputs/orders/stock_targets.json`

- 生成时间：`2026-02-17T22:44:48.664477`
- 模式：`global_momentum`
- 当前市场状态：`regime_on=true`（`signal_reason=risk_on`）
- 目标仓位：`159915=0.5`，`511010=0.2`

### 5. 代码变更
- `/Users/haojc/work/quant-system/scripts/run_stock.py`
- `/Users/haojc/work/quant-system/config/stock.yaml`
- `/Users/haojc/work/quant-system/scripts/backtest_stock_global_model.py`

### 6. 备注
- 生产侧默认已切换到 `mode: global_momentum`。
- 旧版多因子逻辑仍保留在 `run_stock.py` 中，可通过 `mode` 切回。

## 2026-02-17 模型稳健性与对比测试

### 1. 测试脚本
- `/Users/haojc/work/quant-system/scripts/backtest_stock_model_lab.py`

### 2. 输出报告
- `/Users/haojc/work/quant-system/outputs/reports/stock_model_lab_report.json`

### 3. 模型对比结果（相对 510300）

`global_momentum_current`：
- 全周期年化超额：`+0.0907762892`
- OOS 2023 年化超额：`+0.0732623612`
- OOS 2024 年化超额：`+0.0525517989`

`dual_momentum_top2`：
- 全周期年化超额：`+0.0578640519`
- OOS 2023 年化超额：`+0.0227435692`
- OOS 2024 年化超额：`-0.0100244397`

`legacy_multifactor_weekly`：
- 全周期年化超额：`-0.0633428330`
- OOS 2023 年化超额：`-0.0781847006`
- OOS 2024 年化超额：`-0.1257688333`

### 4. 当前模型费用压力测试（OOS 2023）
- `fee=0.0008`：年化超额 `+0.0732623612`
- `fee=0.0012`：年化超额 `+0.0701473554`
- `fee=0.0015`：年化超额 `+0.0678149231`

### 5. 当前模型参数扰动测试（OOS 2023）
- `ma_window=120` 时超额更高：`+0.0801556479`
- `momentum_lb=180` 时超额：`+0.0782542551`
- `top_n=2` 时超额下降：`+0.0397470199`
- 结论：`top_n=1` 与较长动量窗口更稳健。

### 6. Walk-forward（滚动训练-验证）
- 聚合年化超额：`+0.0481343680`
- 聚合终值超额：`+0.2227796079`
- 最常被选参数为：`rebalance_days=20, momentum_lb=252, ma_window=200, vol_window=20, top_n=1`

### 7. 结论
- 当前最优模型仍为 `global_momentum_current`。
- 在 OOS 2023、OOS 2024、费用上调和 walk-forward 下均保持正超额。
- 推荐继续以该模型为生产主模型，下一步优化执行层风控与调仓状态管理。

## 2026-02-17 生产执行层改造（run_stock）

### 1. 代码变更
- `/Users/haojc/work/quant-system/scripts/run_stock.py`
- `/Users/haojc/work/quant-system/config/stock.yaml`

### 2. 新增能力
- 调仓状态持久化：`/Users/haojc/work/quant-system/outputs/state/stock_signal_state.json`
- 最小调仓间隔门控：`execution_guard.min_rebalance_days`
- 最小换手阈值门控：`execution_guard.min_turnover`
- Regime 变化强制调仓：`execution_guard.force_rebalance_on_regime_change`
- 输出字段新增：`market_date`、`execution_guard`、`proposed_targets`

### 3. 当前执行参数
- `execution_guard.enabled=true`
- `execution_guard.min_rebalance_days=20`
- `execution_guard.min_turnover=0.05`
- `execution_guard.force_rebalance_on_regime_change=true`

### 4. 验证结果
- 第一次执行：`action=rebalance`，`reason=normal`
- 第二次执行（同一 market_date）：`action=hold`，`reason=min_rebalance_days`
- 说明执行门控生效，能抑制高频无效调仓。

## 2026-02-17 门控效果对比（加门控 vs 不加门控）

### 1. 对比口径
- 策略：`dual_momentum_trend_ivol_defense`（同一数据、同一参数）
- 手续费：`0.0008`
- 不加门控：每个交易日可更新目标仓位
- 加门控：`min_rebalance_days=20`，`min_turnover=0.05`，`force_rebalance_on_regime_change=true`

### 2. 全样本（2019-03-08 至 2026-02-12）
- 年化收益：`3.2791% -> 3.7776%`
- 最大回撤：`-12.6094% -> -9.5402%`
- 夏普：`0.4120 -> 0.4845`
- 终值：`1.2406 -> 1.2812`
- 交易次数：`82 -> 43`
- 总换手：`82.0 -> 43.0`

### 3. OOS（2023-01-03 至 2026-02-12）
- 年化收益：`4.2960% -> 5.3928%`
- 最大回撤：`-11.0062% -> -7.6116%`
- 夏普：`0.5803 -> 0.8447`
- 终值：`1.1345 -> 1.1707`
- 交易次数：`44 -> 19`
- 总换手：`44.0 -> 19.0`

### 4. 结论
- 门控在当前数据上带来正向改进：收益提升、回撤下降、换手显著下降。
- 生产环境建议保留门控配置，并继续做滚动监控验证稳定性。

## 2026-02-17 `min_rebalance_days` 参数复测（10/12/15/20）

### 1. 对比设定
- 固定：`min_turnover=0.05`，`force_rebalance_on_regime_change=true`，其余模型参数不变。
- 评估窗口：
  - 全样本：2019-03-08 至 2026-02-12
  - OOS：2023-01-03 至 2026-02-12

### 2. OOS 结果
- `20天`：年化 `5.3928%`，最大回撤 `-7.6116%`，夏普 `0.8447`，交易次数 `19`
- `12天`：年化 `5.2111%`，最大回撤 `-6.5986%`，夏普 `0.8246`，交易次数 `24`
- `15天`：年化 `4.9500%`，最大回撤 `-7.7838%`，夏普 `0.7815`，交易次数 `22`
- `10天`：年化 `4.8635%`，最大回撤 `-7.7893%`，夏普 `0.7226`，交易次数 `25`

### 3. 结论
- 在当前样本下，`min_rebalance_days=20` 综合最优（收益/夏普/换手平衡最佳）。
- `10~15` 天并未带来更好 OOS 表现，反而增加了交易频率和换手。
- 配置建议：维持 `min_rebalance_days=20` 不变。

## 2026-02-17 Paper-Forward 日报接入

### 1. 新增脚本
- `/Users/haojc/work/quant-system/scripts/paper_forward_stock.py`

功能：
- 按当前生产模型逐日模拟执行（含 execution_guard）
- 输出每日历史记录（动作、原因、换手、策略/基准收益、净值、回撤）
- 输出最新摘要（latest + aggregate + rolling）

### 2. 输出文件
- `/Users/haojc/work/quant-system/outputs/reports/stock_paper_forward_history.csv`
- `/Users/haojc/work/quant-system/outputs/reports/stock_paper_forward_latest.json`

### 3. 自动化串联
- `/Users/haojc/work/quant-system/scripts/run_all.py` 已追加：
  - `python scripts/paper_forward_stock.py`

### 4. 最新摘要（2026-02-17 生成）
- latest action：`hold`（`reason=min_rebalance_days`）
- latest strategy_nav：`1.2812`
- latest benchmark_nav_raw：`1.5029`
- latest benchmark_nav_alloc：`1.3712`
- rolling excess (vs alloc)：
  - `20d`: `+0.0084`
  - `60d`: `+0.0546`

### 5. 说明
- 日报同时输出两种基准口径：
  - `raw`：100% 持有基准指数
  - `alloc`：按股票资金占比（当前 70%）缩放的基准
- 当前生产模型是“股票子组合”，评估时建议优先看 `vs_alloc` 指标。

## 2026-02-17 自动风控触发器接入

### 1. 代码与配置
- 代码：`/Users/haojc/work/quant-system/scripts/run_stock.py`
- 配置：`/Users/haojc/work/quant-system/config/stock.yaml`

新增配置：
- `global_model.risk_overlay.enabled=true`
- `global_model.risk_overlay.monitor_file=./outputs/reports/stock_paper_forward_latest.json`
- `global_model.risk_overlay.trigger_excess_20d_vs_alloc=-0.02`
- `global_model.risk_overlay.trigger_strategy_drawdown=-0.12`

### 2. 触发逻辑
- 若 `excess_return_20d_vs_alloc <= -0.02`，触发风控覆盖
- 或 `strategy_dd <= -0.12`，触发风控覆盖
- 触发后目标仓位强制改为防守仓：`defensive_symbol=alloc_pct_effective`
- 同时设置 `force_rebalance=true`，执行层门控不再阻挡本次调仓

### 3. 验证结果
- 实盘配置下当前未触发（指标健康）：
  - `excess_return_20d_vs_alloc=+0.0084`
  - `strategy_dd=-0.0262`
- 人工强制触发测试通过：
  - `risk_overlay.triggered=true`
  - `execution_guard.action=rebalance`
  - `execution_guard.reason=risk_overlay_triggered`
  - 目标仓位切换为 `511010=0.7`

## 2026-02-17 自动风控升级（带解除条件）

### 1. 升级内容
- 风控覆盖从“一次性触发”升级为“有状态防守模式”
- 增加解除门槛与最短防守天数，避免频繁开关

### 2. 新增参数
- `release_excess_20d_vs_alloc=0.01`
- `release_strategy_drawdown=-0.06`
- `min_defense_days=10`
- `sticky_mode=true`

### 3. 状态文件
- `/Users/haojc/work/quant-system/outputs/state/stock_risk_overlay_state.json`

### 4. 行为说明
- 触发后进入防守模式并保持（sticky）
- 满足解除条件且达到最短防守天数才退出
- 进入或退出时都会触发 `force_rebalance`，绕过执行门控立即生效

## 2026-02-17 周报接入

### 1. 新增脚本
- `/Users/haojc/work/quant-system/scripts/report_stock_weekly.py`

### 2. 输出文件
- `/Users/haojc/work/quant-system/outputs/reports/stock_weekly_report.json`
- `/Users/haojc/work/quant-system/outputs/reports/stock_weekly_report.md`

### 3. 一键流程
- `/Users/haojc/work/quant-system/scripts/run_all.py` 已追加：
  - `python scripts/report_stock_weekly.py`

### 4. 最新周报摘要
- latest week（`2026-02-06 -> 2026-02-13`）：
  - strategy：`+0.6104%`
  - benchmark(alloc)：`+0.3355%`
  - excess(alloc)：`+0.2776%`
- trailing 8w excess(alloc)：`+4.4073%`

## 2026-02-18 生产化加固与全量验证

### 1. 本次改造
- 新增统一退出码定义：`/Users/haojc/work/quant-system/core/exit_codes.py`
- 关键脚本接入退出码与异常分类：
  - `/Users/haojc/work/quant-system/scripts/fetch_stock_data.py`
  - `/Users/haojc/work/quant-system/scripts/fetch_crypto_data.py`
  - `/Users/haojc/work/quant-system/scripts/run_stock.py`
  - `/Users/haojc/work/quant-system/scripts/run_crypto.py`
  - `/Users/haojc/work/quant-system/scripts/backtest_stock_global_model.py`
  - `/Users/haojc/work/quant-system/scripts/backtest_stock_model_lab.py`
  - `/Users/haojc/work/quant-system/scripts/backtest_v3.py`
  - `/Users/haojc/work/quant-system/scripts/paper_forward_stock.py`
  - `/Users/haojc/work/quant-system/scripts/report_stock_weekly.py`
- 数据拉取降级增强（可用缓存判定 + 多通道重试）：
  - 股票：AkShare 失败时保留本地缓存
  - 币圈：HTX 双域名 + 超时重试 + CCXT fallback + 缓存保底
- 股票风控修正：
  - 非 sticky 模式下触发条件消失可立即退出防守
- 周报口径修正：
  - `excess_ret_vs_alloc` 改为 `strategy_ret - benchmark_ret_alloc`
- 一键编排增强：
  - `run_all.py` 支持 `QS_SKIP_FETCH` 与 `QS_SKIP_REPORTS`

### 2. 自动化测试
- 新增 `tests/` 回归套件（21 项）：
  - 因子函数
  - 风控覆盖与执行门控
  - 数据拉取解析与缓存判定
  - 币圈目标生成
  - paper-forward + 周报
  - 回测报告
  - 交易指令生成
  - run_all 冒烟
- 执行命令：
  - `PYTHONPYCACHEPREFIX=/tmp/pycache python3 -m unittest discover -s tests -v`
- 结果：`21 passed`

### 3. 全流程验证
- 执行命令全部返回 `EXIT:0`：
  - `python3 scripts/fetch_stock_data.py`
  - `python3 scripts/fetch_crypto_data.py`
  - `python3 scripts/backtest_stock_global_model.py`
  - `python3 scripts/backtest_stock_model_lab.py`
  - `python3 scripts/paper_forward_stock.py`
  - `python3 scripts/report_stock_weekly.py`
  - `python3 scripts/backtest_v3.py`
  - `python3 scripts/run_all.py`
  - `python3 scripts/generate_trades.py`

### 4. 最新关键结果（2026-02-18）
- `stock_global_model_report.json`：
  - OOS 年化超额（vs 510300）：`+0.0732623612`
- `stock_model_lab_report.json`：
  - 推荐模型：`global_momentum_current`
  - gate：`passed=true`
- `stock_paper_forward_latest.json`：
  - 策略年化：`3.7776%`
  - 基准年化（alloc）：`4.8379%`
  - 年化超额（vs alloc）：`-1.0603%`
  - 20d 超额（vs alloc）：`+0.8405%`
- `stock_weekly_report.json`（口径修正后）：
  - latest week excess(alloc)：`+0.2749%`
  - trailing 8w excess(alloc)：`+4.5032%`

### 5. 说明
- 当前环境网络受限（代理端口不可达），拉取脚本验证了“失败后可用缓存继续运行”的生产降级路径。
- 软件需求文档已重写为生产版：`/Users/haojc/work/quant-system/软件需求.md`。

## 2026-02-18 代码逻辑复核与一致性修复（第二轮）

### 1. 修复项
- 回测选标逻辑向生产靠拢（`momentum/vol` 评分）：
  - `/Users/haojc/work/quant-system/scripts/backtest_stock_global_model.py`
  - `/Users/haojc/work/quant-system/scripts/backtest_stock_model_lab.py`
- `min_rebalance_days` 语义统一为自然日：
  - `/Users/haojc/work/quant-system/scripts/paper_forward_stock.py`
- `run_all` 对 disabled 模块改为跳过而非失败：
  - `/Users/haojc/work/quant-system/scripts/run_all.py`
- 数据缓存新增新鲜度校验：
  - 股票默认 `15` 天、币圈默认 `5` 天
  - `/Users/haojc/work/quant-system/scripts/fetch_stock_data.py`
  - `/Users/haojc/work/quant-system/scripts/fetch_crypto_data.py`
- `backtest_v3` 股票侧改为 production-aligned（当 `mode=global_momentum`）：
  - `/Users/haojc/work/quant-system/scripts/backtest_v3.py`

### 2. 测试与验证
- 单元/集成测试：`23 passed`
  - `PYTHONPYCACHEPREFIX=/tmp/pycache python3 -m unittest discover -s tests -v`
- 全链路脚本均 `EXIT:0`：
  - `backtest_stock_global_model.py`
  - `backtest_stock_model_lab.py`
  - `paper_forward_stock.py`
  - `report_stock_weekly.py`
  - `backtest_v3.py`
  - `run_all.py`

### 3. 最新观测（修复后）
- `stock_global_model_report.json`（OOS）：
  - 年化超额（vs raw benchmark）`+1.244%`
- `stock_paper_forward_latest.json`：
  - 年化超额（vs alloc）`-1.105%`
  - 20d/60d 超额（vs alloc）均为正（`+1.205%` / `+5.822%`）
- 说明：研究口径与生产口径仍存在用途差异，已在文档中明确标注。

## 2026-02-18 生产参数升级与重回测（第三轮）

### 1. 新增能力
- 新增生产参数搜索脚本：
  - `/Users/haojc/work/quant-system/scripts/backtest_stock_production_search.py`
- 新增测试：
  - `/Users/haojc/work/quant-system/tests/test_production_search.py`

### 2. 参数搜索口径
- 引擎：`paper_forward_stock.run_paper_forward`（生产对齐口径，含 execution_guard）。
- 评估窗口：
  - full（2019-03-08 ~ 2026-02-12）
  - oos_2023（2023-01-03 起）
  - oos_2024（2024-01-02 起）
  - oos_2025（2025-01-02 起）
- 稳定性门控：
  - 四个窗口年化超额（vs alloc）均为正
  - full 最大回撤 > `-18%`

### 3. 选定参数（已写入 `config/stock.yaml`）
- `momentum_lb=252`
- `ma_window=180`
- `vol_window=50`
- `top_n=4`
- `execution_guard.min_rebalance_days=30`
- `execution_guard.min_turnover=0.03`
- `execution_guard.force_rebalance_on_regime_change=false`

### 4. 参数升级结果（baseline -> selected）
- 对比文件：
  - `/Users/haojc/work/quant-system/outputs/reports/stock_param_upgrade_report.json`
- full 年化超额（vs alloc）：`-1.1053% -> +4.2247%`
- oos_2024 年化超额（vs alloc）：`-3.9842% -> +16.1318%`
- oos_2025 年化超额（vs alloc）：`-8.5093% -> +37.1255%`
- full 年化收益：`3.7326% -> 9.0626%`
- full 最大回撤：`-10.8807% -> -11.6951%`
- full Sharpe：`0.4831 -> 0.8093`

### 5. 重跑验证
- `python3 scripts/paper_forward_stock.py`：`EXIT 0`
- `python3 scripts/report_stock_weekly.py`：`EXIT 0`
- `python3 scripts/backtest_v3.py`：`EXIT 0`
- `python3 scripts/backtest_stock_global_model.py`：`EXIT 0`
- `python3 scripts/backtest_stock_model_lab.py`：`EXIT 0`
- `python3 scripts/run_all.py`：`EXIT 0`

### 6. 自动化测试
- `PYTHONPYCACHEPREFIX=/tmp/pycache python3 -m unittest discover -s tests -v`
- 结果：`25 passed`

## 2026-02-18 backtest_v3 研究/生产口径开关

### 1. 功能
- 新增配置项：`config/stock.yaml -> backtest_mode`
  - `production`：股票回测使用 paper-forward 生产对齐口径
  - `research`：股票回测使用研究口径（不含执行门控/风控覆盖）
  - `both`：同时输出两套结果（通过 CLI `--stock-mode both`）

### 2. 代码位置
- `/Users/haojc/work/quant-system/scripts/backtest_v3.py`

## 2026-02-18 backtest_compare 输出补充

### 1. 功能
- `backtest_v3.py` 新增比较摘要输出：`outputs/reports/backtest_compare.json`
- 当 `--stock-mode both`（或等效配置）时，报告包含：
  - `production_better_metrics`
  - `research_better_metrics`
  - `preferred_model`
  - `deltas_production_minus_research`
- 当非 `both` 模式时，比较报告标记为 `available=false` 并给出原因。

### 2. 验证
- 新增测试：
  - `/Users/haojc/work/quant-system/tests/test_backtest_v3_compare.py`

## 2026-02-18 CPCV 参数设计与首轮验证

### 1. 配置落地
- 新增配置：`/Users/haojc/work/quant-system/config/stock.yaml -> validation.cpcv`
- 分组方式（基于当前样本长度）：
  - full：`N=10`, `k=2`, `embargo=20`, `min_fold_days=80`
  - oos_2023：`N=8`, `k=2`, `embargo=15`, `min_fold_days=60`
- Gate 门槛：
  - `excess_ann_mean >= 2.0%`
  - `excess_ann_median >= 1.5%`
  - `excess_ann_worst >= -8.0%`
  - `excess_ann_win_rate >= 0.58`
  - `sharpe_median >= 0.60`
  - `max_drawdown_worst >= -22.0%`

### 2. 新增脚本与测试
- 新增脚本：
  - `/Users/haojc/work/quant-system/scripts/validate_stock_cpcv.py`
- 新增测试：
  - `/Users/haojc/work/quant-system/tests/test_cpcv_validation.py`

### 3. 实跑结果
- 执行：`python3 scripts/validate_stock_cpcv.py`
- 输出：`/Users/haojc/work/quant-system/outputs/reports/stock_cpcv_report.json`
- `full` 窗口摘要：
  - `excess_ann_mean = +6.43%`
  - `excess_ann_median = +6.24%`
  - `excess_ann_worst = -9.66%`
  - `excess_ann_win_rate = 0.80`
  - `sharpe_median = 0.885`
  - `max_drawdown_worst = -14.36%`
  - `gate_passed = false`（仅 `excess_ann_worst` 未达当前 `-8.0%` 门槛）

### 4. 回归验证
- 全量测试：`30 passed`
  - `PYTHONPYCACHEPREFIX=/tmp/pycache python3 -m unittest discover -s tests -v`

## 2026-02-18 CPCV 第二轮（搜索与稳健打分）

### 1. 配置与代码更新
- 更新窗口默认分组（`config/stock.yaml`）：
  - `full`: `N=8`, `k=3`, `embargo=15`, `min_fold_days=80`
  - `oos_2023`: `N=8`, `k=3`, `embargo=15`, `min_fold_days=60`
- 启用 `validation.cpcv.search`：
  - `N in [8,10,12]`
  - `k in [2,3]`
  - `embargo in [10,15,20,30]`
- `scripts/validate_stock_cpcv.py` 增强：
  - 输出 `up/down regime` 条件超额指标
  - 新增搜索结果字段：`gate_passed_results`、`selection_policy`
  - 搜索选择策略：`best_gate_passed_first`
  - 评分函数加入 tail 风险惩罚（`excess_ann_worst/down_excess_ann_worst`）

### 2. 最新实跑结果
- 执行：`python3 scripts/validate_stock_cpcv.py`
- 输出：`/Users/haojc/work/quant-system/outputs/reports/stock_cpcv_report.json`
- 默认窗口结果：
  - `full`: `gate_passed=true`
    - `excess_ann_mean=+4.88%`
    - `excess_ann_worst=-5.88%`
    - `sharpe_median=0.972`
    - `max_drawdown_worst=-11.21%`
  - `oos_2023`: `gate_passed=false`
    - `excess_ann_mean=+5.99%`
    - `excess_ann_worst=-11.76%`（未达 `-8.0%`）
    - `sharpe_median=1.066`
    - `max_drawdown_worst=-10.03%`
- 搜索 best（按 `best_gate_passed_first`）：
  - `full`: `8/3/10`，`best_gate_passed=true`
  - `oos_2023`: `8/3/15`，`best_gate_passed=false`（当前网格无 gate 通过组合）

### 3. 回归验证
- 全量测试：`31 passed`
  - `PYTHONPYCACHEPREFIX=/tmp/pycache python3 -m unittest discover -s tests -v`

## 2026-02-18 交易策略执行（同意后落地与修正）

### 1. 初版“黄灯”参数（已验证不采用）
- 首次按方案下发：
  - `capital_alloc_pct=0.60`
  - `min_rebalance_days=20`
  - `force_rebalance_on_regime_change=true`
  - `trigger_excess_20d_vs_alloc=-0.015`
  - `trigger_strategy_drawdown=-0.10`
- 回测结果（`backtest_v3 --stock-mode production`）：
  - 年化：`4.5193%`
  - 超额（vs alloc）：`+0.2506%`
  - 最大回撤：`-11.4577%`
  - Sharpe：`0.5269`
- 结论：收益与超额显著下降，不适合直接采用。

### 2. 诊断与修正
- 诊断：
  - 在 `capital_alloc_pct` 从 `0.70` 降到 `0.60` 后，`min_turnover=0.03` 未按仓位缩放，等效门槛变“更严格”，导致大量应调未调。
  - `min_rebalance_days=20 + regime 强制调仓` 会显著增加路径扰动，历史样本下收益风险比恶化。
- 修正参数（当前生效）：
  - `capital_alloc_pct=0.60`
  - `min_rebalance_days=30`
  - `min_turnover=0.026`（按 60% 仓位缩放）
  - `force_rebalance_on_regime_change=false`
  - 风控触发阈值回退为 `-0.02 / -0.12`

### 3. 修正后结果
- 生产口径回测（`backtest_v3 --stock-mode production`）：
  - 年化：`8.0426%`
  - 超额（vs alloc）：`+3.7739%`
  - 最大回撤：`-10.3893%`
  - Sharpe：`0.8151`
- 对比旧 70% 仓位基线（`9.0626% / +4.2247% / -11.6951% / 0.8093`）：
  - 收益略降，但回撤显著改善，Sharpe 小幅提升。
- CPCV（`validate_stock_cpcv.py`）：
  - `full`：`gate_passed=true`，`excess_ann_worst=-4.68%`（优于之前）
  - `oos_2023`：`gate_passed=false`，`excess_ann_worst=-9.66%`（较之前 `-11.76%` 改善，但仍未达 `-8.0%` 门槛）

## 2026-02-18 execution_guard 动态 min_turnover

### 1. 目标
- 避免每次调整 `capital_alloc_pct` 时手动改 `min_turnover`。

### 2. 方案落地
- 新增模块：`/Users/haojc/work/quant-system/core/execution_guard.py`
  - `resolve_min_turnover(base, alloc, guard_cfg)` 统一计算动态阈值。
- 接入位置：
  - `/Users/haojc/work/quant-system/scripts/run_stock.py`
  - `/Users/haojc/work/quant-system/scripts/paper_forward_stock.py`
- 配置（`config/stock.yaml`）：
  - `min_turnover=0.03`（基准）
  - `dynamic_min_turnover.enabled=true`
  - `alloc_ref=0.70`
  - `min_multiplier=0.60`, `max_multiplier=1.40`
  - `floor=0.018`, `ceil=0.050`
- 当前 `alloc=0.60` 下自动得到：
  - `effective_min_turnover=0.025714...`（无需手动改参）

### 3. 验证结果
- 生产口径回测（`backtest_v3 --stock-mode production`）：
  - 年化：`8.0424%`
  - 超额（vs alloc）：`+3.7738%`
  - 最大回撤：`-10.3893%`
  - Sharpe：`0.8151`
- CPCV（`validate_stock_cpcv.py`）：
  - `full`: `gate_passed=true`, `excess_ann_worst=-4.68%`
  - `oos_2023`: `gate_passed=false`, `excess_ann_worst=-9.66%`

### 4. 测试
- 新增测试：
  - `/Users/haojc/work/quant-system/tests/test_execution_guard_dynamic.py`
- 全量测试：
  - `33 passed`
  - `PYTHONPYCACHEPREFIX=/tmp/pycache python3 -m unittest discover -s tests -v`

## 2026-02-18 收益优先模式（仓位回升至 70%）

### 1. 调整项
- `capital_alloc_pct`: `0.60 -> 0.70`
- 保持 execution_guard：
  - `min_rebalance_days=30`
  - `min_turnover(base)=0.03`
  - `dynamic_min_turnover.enabled=true`
  - 当前 `effective_min_turnover=0.03`（因 `alloc=alloc_ref=0.70`）

### 2. 结果
- `python3 scripts/backtest_v3.py --stock-mode production`
  - 年化：`9.0626%`
  - 超额（vs alloc）：`+4.2247%`
  - 最大回撤：`-11.6951%`
  - Sharpe：`0.8093`
- `python3 scripts/backtest_v3.py --stock-mode both`
  - production 年化：`9.0626%`
  - research 年化：`7.8416%`
  - production 在收益、超额、回撤、Sharpe 上均优于 research
- `python3 scripts/validate_stock_cpcv.py`
  - `full`: `gate_passed=true`，`excess_ann_worst=-5.88%`
  - `oos_2023`: `gate_passed=false`，`excess_ann_worst=-11.76%`

### 3. 结论
- 若目标优先级是“更高收益率”，当前 70% 仓位版本优于 60% 仓位版本；
- 但 `oos_2023` 的尾部风险门槛仍未通过，需要后续继续优化模型稳健性。

## 2026-02-18 滚动仓位开关（63/126）接入与回测

### 1. 实现
- 新增：`/Users/haojc/work/quant-system/core/exposure_gate.py`
  - 基于最近 `63/126` 交易日执行滚动评估，输出 `pass/warn/risk` 仓位分档。
- 接入：
  - `run_stock.py`：输出 `exposure_gate` 元数据到 `stock_targets.json`
  - `paper_forward_stock.py`：逐日模拟中按开关调整 `alloc_pct_effective`
- 配置：
  - `config/stock.yaml -> global_model.exposure_gate`

### 2. 回测效果（同一参数集）
- `gate_off`（当前默认）：
  - 年化 `9.0626%`
  - 超额（vs alloc）`+4.2247%`
  - 最大回撤 `-11.6951%`
  - Sharpe `0.8093`
- `gate_on_default`（`warn=-0.10, risk=-0.14, cap=0.60/0.50`）：
  - 年化 `4.4615%`
  - 超额 `-0.3764%`
  - 最大回撤 `-13.0158%`
  - Sharpe `0.5388`
- `gate_on_relaxed`（`warn=-0.18, risk=-0.26, cap=0.65/0.55`）：
  - 年化 `7.6377%`
  - 超额 `+2.7998%`
  - 最大回撤 `-12.9616%`
  - Sharpe `0.8069`

### 3. 结论与当前决策
- 开关功能可用，但当前阈值体系下对收益拖累明显，且回撤未改善。
- 现阶段保留能力，默认 `enabled=false`，不纳入生产默认路径。

### 4. 回归验证
- 全量测试：`35 passed`
  - `PYTHONPYCACHEPREFIX=/tmp/pycache python3 -m unittest discover -s tests -v`

## 2026-02-18 基线固化（对照组）

### 1. 目标
- 固化当前可用生产参数与关键报告，作为后续迭代的对照基线。

### 2. 基线快照
- Baseline ID：`stock_prod_baseline_20260218_212447`
- 路径：`/Users/haojc/work/quant-system/outputs/reports/baselines/stock_prod_baseline_20260218_212447`
- 快照索引：`/Users/haojc/work/quant-system/outputs/reports/baseline_latest.json`
- Manifest：`/Users/haojc/work/quant-system/outputs/reports/baselines/stock_prod_baseline_20260218_212447/baseline_manifest.json`

### 3. 固化内容
- 配置：`stock.yaml`、`risk.yaml`、`runtime.yaml`
- 报告：`backtest_report.json`、`backtest_compare.json`、`stock_paper_forward_latest.json`、`stock_paper_forward_history.csv`、`stock_cpcv_report.json`
- 每个文件记录了 `sha256` 与大小，便于对照追溯。
