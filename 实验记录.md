# 实验记录

## 2026-02-17 股票模型接入与回测记录

### 1. 目标
- 将股票生产信号切换到 `dual_momentum_trend_ivol_defense` 模型。
- 验证该模型相对基准 `510300` 的超额收益。

### 2. 本次测试配置
- 环境：`paper`
- 总资金：`20000`
- 股票资金分配：`0.70`
- 股票单标上限：`0.50`
- 股票总仓上限：`0.70`

模型参数（回测与生产一致）：
- `rebalance_days`: `20`
- `momentum_lb`: `252`
- `ma_window`: `200`
- `vol_window`: `20`
- `top_n`: `1`
- `fee`: `0.0008`
- `min_score`: `0.0`
- `benchmark_symbol`: `510300`
- `defensive_symbol`: `511010`
- `defensive_bypass_single_max`: `true`

### 3. 回测结果
来源文件：`/Users/haojc/work/quant-system/outputs/reports/stock_global_model_report.json`

样本外（2023-01-03 之后）：
- 策略年化：`0.1679210629`
- 基准年化：`0.0946587018`
- 年化超额：`+0.0732623612`
- 策略最大回撤：`-0.1891511196`
- 基准最大回撤：`-0.2415286624`
- 策略终值：`1.5921095910`
- 基准终值：`1.3112343967`

全周期：
- 策略年化：`0.1555737278`
- 基准年化：`0.0647974386`
- 年化超额：`+0.0907762892`
- 策略最大回撤：`-0.2317839787`
- 基准最大回撤：`-0.4474758723`
- 策略终值：`2.6266285144`
- 基准终值：`1.5209137709`

### 4. 当前生产信号输出快照
来源文件：`/Users/haojc/work/quant-system/outputs/orders/stock_targets.json`

- 生成时间：`2026-02-17T22:44:48.664477`
- 模式：`global_momentum`
- 当前市场状态：`regime_on=true`（`signal_reason=risk_on`）
- 目标仓位：`159915=0.5`，`511010=0.2`

### 5. 代码变更
- `/Users/haojc/work/quant-system/scripts/run_stock.py`
- `/Users/haojc/work/quant-system/config/stock.yaml`
- `/Users/haojc/work/quant-system/scripts/backtest_stock_global_model.py`

### 6. 备注
- 生产侧默认已切换到 `mode: global_momentum`。
- 旧版多因子逻辑仍保留在 `run_stock.py` 中，可通过 `mode` 切回。

## 2026-02-17 模型稳健性与对比测试

### 1. 测试脚本
- `/Users/haojc/work/quant-system/scripts/backtest_stock_model_lab.py`

### 2. 输出报告
- `/Users/haojc/work/quant-system/outputs/reports/stock_model_lab_report.json`

### 3. 模型对比结果（相对 510300）

`global_momentum_current`：
- 全周期年化超额：`+0.0907762892`
- OOS 2023 年化超额：`+0.0732623612`
- OOS 2024 年化超额：`+0.0525517989`

`dual_momentum_top2`：
- 全周期年化超额：`+0.0578640519`
- OOS 2023 年化超额：`+0.0227435692`
- OOS 2024 年化超额：`-0.0100244397`

`legacy_multifactor_weekly`：
- 全周期年化超额：`-0.0633428330`
- OOS 2023 年化超额：`-0.0781847006`
- OOS 2024 年化超额：`-0.1257688333`

### 4. 当前模型费用压力测试（OOS 2023）
- `fee=0.0008`：年化超额 `+0.0732623612`
- `fee=0.0012`：年化超额 `+0.0701473554`
- `fee=0.0015`：年化超额 `+0.0678149231`

### 5. 当前模型参数扰动测试（OOS 2023）
- `ma_window=120` 时超额更高：`+0.0801556479`
- `momentum_lb=180` 时超额：`+0.0782542551`
- `top_n=2` 时超额下降：`+0.0397470199`
- 结论：`top_n=1` 与较长动量窗口更稳健。

### 6. Walk-forward（滚动训练-验证）
- 聚合年化超额：`+0.0481343680`
- 聚合终值超额：`+0.2227796079`
- 最常被选参数为：`rebalance_days=20, momentum_lb=252, ma_window=200, vol_window=20, top_n=1`

### 7. 结论
- 当前最优模型仍为 `global_momentum_current`。
- 在 OOS 2023、OOS 2024、费用上调和 walk-forward 下均保持正超额。
- 推荐继续以该模型为生产主模型，下一步优化执行层风控与调仓状态管理。

## 2026-02-17 生产执行层改造（run_stock）

### 1. 代码变更
- `/Users/haojc/work/quant-system/scripts/run_stock.py`
- `/Users/haojc/work/quant-system/config/stock.yaml`

### 2. 新增能力
- 调仓状态持久化：`/Users/haojc/work/quant-system/outputs/state/stock_signal_state.json`
- 最小调仓间隔门控：`execution_guard.min_rebalance_days`
- 最小换手阈值门控：`execution_guard.min_turnover`
- Regime 变化强制调仓：`execution_guard.force_rebalance_on_regime_change`
- 输出字段新增：`market_date`、`execution_guard`、`proposed_targets`

### 3. 当前执行参数
- `execution_guard.enabled=true`
- `execution_guard.min_rebalance_days=20`
- `execution_guard.min_turnover=0.05`
- `execution_guard.force_rebalance_on_regime_change=true`

### 4. 验证结果
- 第一次执行：`action=rebalance`，`reason=normal`
- 第二次执行（同一 market_date）：`action=hold`，`reason=min_rebalance_days`
- 说明执行门控生效，能抑制高频无效调仓。

## 2026-02-17 门控效果对比（加门控 vs 不加门控）

### 1. 对比口径
- 策略：`dual_momentum_trend_ivol_defense`（同一数据、同一参数）
- 手续费：`0.0008`
- 不加门控：每个交易日可更新目标仓位
- 加门控：`min_rebalance_days=20`，`min_turnover=0.05`，`force_rebalance_on_regime_change=true`

### 2. 全样本（2019-03-08 至 2026-02-12）
- 年化收益：`3.2791% -> 3.7776%`
- 最大回撤：`-12.6094% -> -9.5402%`
- 夏普：`0.4120 -> 0.4845`
- 终值：`1.2406 -> 1.2812`
- 交易次数：`82 -> 43`
- 总换手：`82.0 -> 43.0`

### 3. OOS（2023-01-03 至 2026-02-12）
- 年化收益：`4.2960% -> 5.3928%`
- 最大回撤：`-11.0062% -> -7.6116%`
- 夏普：`0.5803 -> 0.8447`
- 终值：`1.1345 -> 1.1707`
- 交易次数：`44 -> 19`
- 总换手：`44.0 -> 19.0`

### 4. 结论
- 门控在当前数据上带来正向改进：收益提升、回撤下降、换手显著下降。
- 生产环境建议保留门控配置，并继续做滚动监控验证稳定性。

## 2026-02-17 `min_rebalance_days` 参数复测（10/12/15/20）

### 1. 对比设定
- 固定：`min_turnover=0.05`，`force_rebalance_on_regime_change=true`，其余模型参数不变。
- 评估窗口：
  - 全样本：2019-03-08 至 2026-02-12
  - OOS：2023-01-03 至 2026-02-12

### 2. OOS 结果
- `20天`：年化 `5.3928%`，最大回撤 `-7.6116%`，夏普 `0.8447`，交易次数 `19`
- `12天`：年化 `5.2111%`，最大回撤 `-6.5986%`，夏普 `0.8246`，交易次数 `24`
- `15天`：年化 `4.9500%`，最大回撤 `-7.7838%`，夏普 `0.7815`，交易次数 `22`
- `10天`：年化 `4.8635%`，最大回撤 `-7.7893%`，夏普 `0.7226`，交易次数 `25`

### 3. 结论
- 在当前样本下，`min_rebalance_days=20` 综合最优（收益/夏普/换手平衡最佳）。
- `10~15` 天并未带来更好 OOS 表现，反而增加了交易频率和换手。
- 配置建议：维持 `min_rebalance_days=20` 不变。

## 2026-02-17 Paper-Forward 日报接入

### 1. 新增脚本
- `/Users/haojc/work/quant-system/scripts/paper_forward_stock.py`

功能：
- 按当前生产模型逐日模拟执行（含 execution_guard）
- 输出每日历史记录（动作、原因、换手、策略/基准收益、净值、回撤）
- 输出最新摘要（latest + aggregate + rolling）

### 2. 输出文件
- `/Users/haojc/work/quant-system/outputs/reports/stock_paper_forward_history.csv`
- `/Users/haojc/work/quant-system/outputs/reports/stock_paper_forward_latest.json`

### 3. 自动化串联
- `/Users/haojc/work/quant-system/scripts/run_all.py` 已追加：
  - `python scripts/paper_forward_stock.py`

### 4. 最新摘要（2026-02-17 生成）
- latest action：`hold`（`reason=min_rebalance_days`）
- latest strategy_nav：`1.2812`
- latest benchmark_nav_raw：`1.5029`
- latest benchmark_nav_alloc：`1.3712`
- rolling excess (vs alloc)：
  - `20d`: `+0.0084`
  - `60d`: `+0.0546`

### 5. 说明
- 日报同时输出两种基准口径：
  - `raw`：100% 持有基准指数
  - `alloc`：按股票资金占比（当前 70%）缩放的基准
- 当前生产模型是“股票子组合”，评估时建议优先看 `vs_alloc` 指标。

## 2026-02-17 自动风控触发器接入

### 1. 代码与配置
- 代码：`/Users/haojc/work/quant-system/scripts/run_stock.py`
- 配置：`/Users/haojc/work/quant-system/config/stock.yaml`

新增配置：
- `global_model.risk_overlay.enabled=true`
- `global_model.risk_overlay.monitor_file=./outputs/reports/stock_paper_forward_latest.json`
- `global_model.risk_overlay.trigger_excess_20d_vs_alloc=-0.02`
- `global_model.risk_overlay.trigger_strategy_drawdown=-0.12`

### 2. 触发逻辑
- 若 `excess_return_20d_vs_alloc <= -0.02`，触发风控覆盖
- 或 `strategy_dd <= -0.12`，触发风控覆盖
- 触发后目标仓位强制改为防守仓：`defensive_symbol=alloc_pct_effective`
- 同时设置 `force_rebalance=true`，执行层门控不再阻挡本次调仓

### 3. 验证结果
- 实盘配置下当前未触发（指标健康）：
  - `excess_return_20d_vs_alloc=+0.0084`
  - `strategy_dd=-0.0262`
- 人工强制触发测试通过：
  - `risk_overlay.triggered=true`
  - `execution_guard.action=rebalance`
  - `execution_guard.reason=risk_overlay_triggered`
  - 目标仓位切换为 `511010=0.7`

## 2026-02-17 自动风控升级（带解除条件）

### 1. 升级内容
- 风控覆盖从“一次性触发”升级为“有状态防守模式”
- 增加解除门槛与最短防守天数，避免频繁开关

### 2. 新增参数
- `release_excess_20d_vs_alloc=0.01`
- `release_strategy_drawdown=-0.06`
- `min_defense_days=10`
- `sticky_mode=true`

### 3. 状态文件
- `/Users/haojc/work/quant-system/outputs/state/stock_risk_overlay_state.json`

### 4. 行为说明
- 触发后进入防守模式并保持（sticky）
- 满足解除条件且达到最短防守天数才退出
- 进入或退出时都会触发 `force_rebalance`，绕过执行门控立即生效

## 2026-02-17 周报接入

### 1. 新增脚本
- `/Users/haojc/work/quant-system/scripts/report_stock_weekly.py`

### 2. 输出文件
- `/Users/haojc/work/quant-system/outputs/reports/stock_weekly_report.json`
- `/Users/haojc/work/quant-system/outputs/reports/stock_weekly_report.md`

### 3. 一键流程
- `/Users/haojc/work/quant-system/scripts/run_all.py` 已追加：
  - `python scripts/report_stock_weekly.py`

### 4. 最新周报摘要
- latest week（`2026-02-06 -> 2026-02-13`）：
  - strategy：`+0.6104%`
  - benchmark(alloc)：`+0.3355%`
  - excess(alloc)：`+0.2776%`
- trailing 8w excess(alloc)：`+4.4073%`

## 2026-02-18 生产化加固与全量验证

### 1. 本次改造
- 新增统一退出码定义：`/Users/haojc/work/quant-system/core/exit_codes.py`
- 关键脚本接入退出码与异常分类：
  - `/Users/haojc/work/quant-system/scripts/fetch_stock_data.py`
  - `/Users/haojc/work/quant-system/scripts/fetch_crypto_data.py`
  - `/Users/haojc/work/quant-system/scripts/run_stock.py`
  - `/Users/haojc/work/quant-system/scripts/run_crypto.py`
  - `/Users/haojc/work/quant-system/scripts/backtest_stock_global_model.py`
  - `/Users/haojc/work/quant-system/scripts/backtest_stock_model_lab.py`
  - `/Users/haojc/work/quant-system/scripts/backtest_v3.py`
  - `/Users/haojc/work/quant-system/scripts/paper_forward_stock.py`
  - `/Users/haojc/work/quant-system/scripts/report_stock_weekly.py`
- 数据拉取降级增强（可用缓存判定 + 多通道重试）：
  - 股票：AkShare 失败时保留本地缓存
  - 币圈：HTX 双域名 + 超时重试 + CCXT fallback + 缓存保底
- 股票风控修正：
  - 非 sticky 模式下触发条件消失可立即退出防守
- 周报口径修正：
  - `excess_ret_vs_alloc` 改为 `strategy_ret - benchmark_ret_alloc`
- 一键编排增强：
  - `run_all.py` 支持 `QS_SKIP_FETCH` 与 `QS_SKIP_REPORTS`

### 2. 自动化测试
- 新增 `tests/` 回归套件（21 项）：
  - 因子函数
  - 风控覆盖与执行门控
  - 数据拉取解析与缓存判定
  - 币圈目标生成
  - paper-forward + 周报
  - 回测报告
  - 交易指令生成
  - run_all 冒烟
- 执行命令：
  - `PYTHONPYCACHEPREFIX=/tmp/pycache python3 -m unittest discover -s tests -v`
- 结果：`21 passed`

### 3. 全流程验证
- 执行命令全部返回 `EXIT:0`：
  - `python3 scripts/fetch_stock_data.py`
  - `python3 scripts/fetch_crypto_data.py`
  - `python3 scripts/backtest_stock_global_model.py`
  - `python3 scripts/backtest_stock_model_lab.py`
  - `python3 scripts/paper_forward_stock.py`
  - `python3 scripts/report_stock_weekly.py`
  - `python3 scripts/backtest_v3.py`
  - `python3 scripts/run_all.py`
  - `python3 scripts/generate_trades.py`

### 4. 最新关键结果（2026-02-18）
- `stock_global_model_report.json`：
  - OOS 年化超额（vs 510300）：`+0.0732623612`
- `stock_model_lab_report.json`：
  - 推荐模型：`global_momentum_current`
  - gate：`passed=true`
- `stock_paper_forward_latest.json`：
  - 策略年化：`3.7776%`
  - 基准年化（alloc）：`4.8379%`
  - 年化超额（vs alloc）：`-1.0603%`
  - 20d 超额（vs alloc）：`+0.8405%`
- `stock_weekly_report.json`（口径修正后）：
  - latest week excess(alloc)：`+0.2749%`
  - trailing 8w excess(alloc)：`+4.5032%`

### 5. 说明
- 当前环境网络受限（代理端口不可达），拉取脚本验证了“失败后可用缓存继续运行”的生产降级路径。
- 软件需求文档已重写为生产版：`/Users/haojc/work/quant-system/软件需求.md`。

## 2026-02-18 代码逻辑复核与一致性修复（第二轮）

### 1. 修复项
- 回测选标逻辑向生产靠拢（`momentum/vol` 评分）：
  - `/Users/haojc/work/quant-system/scripts/backtest_stock_global_model.py`
  - `/Users/haojc/work/quant-system/scripts/backtest_stock_model_lab.py`
- `min_rebalance_days` 语义统一为自然日：
  - `/Users/haojc/work/quant-system/scripts/paper_forward_stock.py`
- `run_all` 对 disabled 模块改为跳过而非失败：
  - `/Users/haojc/work/quant-system/scripts/run_all.py`
- 数据缓存新增新鲜度校验：
  - 股票默认 `15` 天、币圈默认 `5` 天
  - `/Users/haojc/work/quant-system/scripts/fetch_stock_data.py`
  - `/Users/haojc/work/quant-system/scripts/fetch_crypto_data.py`
- `backtest_v3` 股票侧改为 production-aligned（当 `mode=global_momentum`）：
  - `/Users/haojc/work/quant-system/scripts/backtest_v3.py`

### 2. 测试与验证
- 单元/集成测试：`23 passed`
  - `PYTHONPYCACHEPREFIX=/tmp/pycache python3 -m unittest discover -s tests -v`
- 全链路脚本均 `EXIT:0`：
  - `backtest_stock_global_model.py`
  - `backtest_stock_model_lab.py`
  - `paper_forward_stock.py`
  - `report_stock_weekly.py`
  - `backtest_v3.py`
  - `run_all.py`

### 3. 最新观测（修复后）
- `stock_global_model_report.json`（OOS）：
  - 年化超额（vs raw benchmark）`+1.244%`
- `stock_paper_forward_latest.json`：
  - 年化超额（vs alloc）`-1.105%`
  - 20d/60d 超额（vs alloc）均为正（`+1.205%` / `+5.822%`）
- 说明：研究口径与生产口径仍存在用途差异，已在文档中明确标注。

## 2026-02-18 生产参数升级与重回测（第三轮）

### 1. 新增能力
- 新增生产参数搜索脚本：
  - `/Users/haojc/work/quant-system/scripts/backtest_stock_production_search.py`
- 新增测试：
  - `/Users/haojc/work/quant-system/tests/test_production_search.py`

### 2. 参数搜索口径
- 引擎：`paper_forward_stock.run_paper_forward`（生产对齐口径，含 execution_guard）。
- 评估窗口：
  - full（2019-03-08 ~ 2026-02-12）
  - oos_2023（2023-01-03 起）
  - oos_2024（2024-01-02 起）
  - oos_2025（2025-01-02 起）
- 稳定性门控：
  - 四个窗口年化超额（vs alloc）均为正
  - full 最大回撤 > `-18%`

### 3. 选定参数（已写入 `config/stock.yaml`）
- `momentum_lb=252`
- `ma_window=180`
- `vol_window=50`
- `top_n=4`
- `execution_guard.min_rebalance_days=30`
- `execution_guard.min_turnover=0.03`
- `execution_guard.force_rebalance_on_regime_change=false`

### 4. 参数升级结果（baseline -> selected）
- 对比文件：
  - `/Users/haojc/work/quant-system/outputs/reports/stock_param_upgrade_report.json`
- full 年化超额（vs alloc）：`-1.1053% -> +4.2247%`
- oos_2024 年化超额（vs alloc）：`-3.9842% -> +16.1318%`
- oos_2025 年化超额（vs alloc）：`-8.5093% -> +37.1255%`
- full 年化收益：`3.7326% -> 9.0626%`
- full 最大回撤：`-10.8807% -> -11.6951%`
- full Sharpe：`0.4831 -> 0.8093`

### 5. 重跑验证
- `python3 scripts/paper_forward_stock.py`：`EXIT 0`
- `python3 scripts/report_stock_weekly.py`：`EXIT 0`
- `python3 scripts/backtest_v3.py`：`EXIT 0`
- `python3 scripts/backtest_stock_global_model.py`：`EXIT 0`
- `python3 scripts/backtest_stock_model_lab.py`：`EXIT 0`
- `python3 scripts/run_all.py`：`EXIT 0`

### 6. 自动化测试
- `PYTHONPYCACHEPREFIX=/tmp/pycache python3 -m unittest discover -s tests -v`
- 结果：`25 passed`

## 2026-02-18 backtest_v3 研究/生产口径开关

### 1. 功能
- 新增配置项：`config/stock.yaml -> backtest_mode`
  - `production`：股票回测使用 paper-forward 生产对齐口径
  - `research`：股票回测使用研究口径（不含执行门控/风控覆盖）
  - `both`：同时输出两套结果（通过 CLI `--stock-mode both`）

### 2. 代码位置
- `/Users/haojc/work/quant-system/scripts/backtest_v3.py`
